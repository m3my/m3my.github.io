"use strict";angular.module("movieMemoryApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angular-lodash","firebase","timer"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/game.html",controller:"MainCtrl"}).when("/games/:id",{templateUrl:"views/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]),Firebase.enableLogging(!1),angular.module("movieMemoryApp").controller("MainCtrl",["$scope","Game","$location","$firebase",function(a,b,c,d){function e(a){for(var b=(a.length,12),d=_.sample(a,b),e=[],g=[],h=0;b>h;++h){var i=d[h];e[h]=angular.copy(i),e[h].type="cover",e[h].status="fresh",g[h]=angular.copy(i),g[h].type="tags",g[h].status="fresh"}var j=g.concat(e),k=_.shuffle(_.range(2*b)),l=[];for(h=0;2*b>h;++h)l[h]=j[k[h]];f.$add({cards:l}).then(function(a){var b=a.name();c.path("games/"+b)})}a.app.error="",a.app.flippedCards=[];var f=b.$asArray();a.play=function(){var a=new Firebase("https://popping-heat-9121.firebaseio.com/movies"),b=d(a).$asArray();b.$loaded(function(a){e(a)},function(a){console.error(a)})},a.play()}]),angular.module("movieMemoryApp").controller("GameCtrl",["$scope","$routeParams","$firebase","$timeout","$location",function(a,b,c,d,e){a.location=e.absUrl(),a.app.error="",a.app.warning="",a.app.information="",a.app.success="",a.app.flippedCards=[];var f=new Firebase("https://popping-heat-9121.firebaseio.com/games/"+b.id);c(f).$asObject().$bindTo(a,"game").then(function(){a.$watch("game.cards",function(b){b&&(a.app.flippedCards=_.sortBy(_.where(b,{status:"flipped"}),"updatedAt"))},!0),a.$watch("game.cards",function(b){if(b){var c=_.groupBy(b,function(a,b){return Math.floor(b/6)});a.app.chunkedCards=_.toArray(c)}},!0),0===(_.where(a.game.players,{id:a.user.id})||[]).length&&((a.game.players=a.game.players||[]).length<2?(a.game.players.push(angular.extend(a.user,{score:0})),2===a.game.players.length&&(a.game.activePlayer=a.user.id)):a.app.error="Sorry, all 2 seats are already taken :(")}),a.flipCard=function(b){a.game.activePlayer===a.user.id&&a.app.flippedCards.length<2&&(b.status="flipped",b.updatedAt=(new Date).getTime(),a.$broadcast("timer-stop"))},a.$watch("app.flippedCards.length",function(b){if(2===b){var c=a.game.activePlayer===a.user.id;console.log("Active player: "+a.game.activePlayer),console.log("I am "+(c?"":"not ")+"active");var e=a.app.flippedCards[0].IMDB_Id===a.app.flippedCards[1].IMDB_Id;d(function(){if(c){var b=a.game.players[0].id===a.game.activePlayer?0:1;e?(_.each(a.app.flippedCards,function(a){a.status="scored"}),a.game.players[b].score++):(_.each(a.app.flippedCards,function(a){a.status="fresh"}),a.game.activePlayer=a.game.players[1-b].id,console.log("Giving control to player "+a.game.activePlayer))}},2e3)}})}]),angular.module("movieMemoryApp").directive("setPreviewCardSize",["$window","$timeout",function(a,b){return{restrict:"A",link:function(c,d){var e=30,f=function(){var b=(a.innerHeight-$(".mmyGameTopBar").height()-3*e)/2,c=3*b/4;return d.css({height:b+"px",width:c+"px"})};b(f),angular.element(a).on("resize",f);var g=function(){return angular.element(a).off("resize",f)};d.on("$destroy",g)}}}]),angular.module("movieMemoryApp").directive("setCardSize",["$window","$timeout",function(a,b){return{restrict:"A",link:function(c,d){var e=120,f=function(){var b=(a.innerHeight-$(".mmyGameTopBar").height()-e)/4,c=3*b/4;return d.css({height:b+"px",width:c+"px"})};b(f),angular.element(a).on("resize",f);var g=function(){return angular.element(a).off("resize",f)};d.on("$destroy",g)}}}]),angular.module("movieMemoryApp").directive("backgroundImage",["$document",function(a){return{restrict:"A",scope:{backgroundImage:"="},link:function(b,c){b.$watch("backgroundImage",function(){var d=b.backgroundImage;if(d){var e=a[0].createElement("img");e.onload=function(){c.css({backgroundImage:"url("+this.src+")",backgroundSize:"cover"}),c.addClass("loaded")},e.src=d}})}}}]),angular.module("movieMemoryApp").service("Game",["$firebase",function(a){var b=new Firebase("https://popping-heat-9121.firebaseio.com/games");return a(b)}]),angular.module("movieMemoryApp").filter("partition",function(){var a={},b=function(b,c,d){var e,f=0,g=[],h=d.$id,i=a[h];if(b){if(i)for(e=0;e<i.length;e++)f+=i[e].length;if(b.length===f)return i;for(e=0;e<b.length;e+=c)g.push(b.slice(e,e+c));return a[h]=g,g}};return b}),angular.module("movieMemoryApp").controller("ApplicationCtrl",["$scope","Guid","$cookies",function(a,b,c){var d=c.moviememoryCookie;void 0===d&&(c.moviememoryCookie=b()),a.user={id:c.moviememoryCookie},a.app={error:""}}]),angular.module("movieMemoryApp").service("Guid",function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}),angular.module("movieMemoryApp").directive("adjustHeight",["$window","$timeout",function(a,b){return{restrict:"A",link:function(c,d){var e=function(){var b=a.innerHeight-$(".mmyGameTopBar").height();return d.css("height",b+"px")};b(e),angular.element(a).on("resize",e);var f=function(){return angular.element(a).off("resize",e)};d.on("$destroy",f)}}}]);